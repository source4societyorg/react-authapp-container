'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.outputErrorLogFunction=exports.validateReducerKeyFunction=exports.checkJwtExpiration=exports.makeApiCall=undefined;exports.sagaHandler=sagaHandler;exports.handleDoubleCookieFunction=handleDoubleCookieFunction;exports.fetchLocalStorageData=fetchLocalStorageData;exports.putInLocalStorage=putInLocalStorage;exports.loadAuthDataFromLocalStorage=loadAuthDataFromLocalStorage;exports.default=localStorageData;var _moment=require('moment');var _moment2=_interopRequireDefault(_moment);var _scepterUtilityLib=require('@source4society/scepter-utility-lib');var _effects=require('redux-saga/effects');var _actions=require('./actions');var _selectors=require('./selectors');var _constants=require('./constants');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _marked=/*#__PURE__*/regeneratorRuntime.mark(sagaHandler),_marked2=/*#__PURE__*/regeneratorRuntime.mark(handleDoubleCookieFunction),_marked3=/*#__PURE__*/regeneratorRuntime.mark(fetchLocalStorageData),_marked4=/*#__PURE__*/regeneratorRuntime.mark(putInLocalStorage),_marked5=/*#__PURE__*/regeneratorRuntime.mark(loadAuthDataFromLocalStorage),_marked6=/*#__PURE__*/regeneratorRuntime.mark(localStorageData);function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}var makeApiCall=exports.makeApiCall=function makeApiCall(ApiInterface){return(/*#__PURE__*/regeneratorRuntime.mark(function apiCall(apiToCall,parameters,injectedExtraParams,injectMakeSelectJwt,injectMakeSelectExpires,injectMakeSelectDoubleCookie,injectedHandleDoubleCookie){var extraParams,makeSelectJwtSelector,makeSelectExpiresSelector,makeSelectDoubleCookieSelector,handleDoubleCookie,jwt,expires,doubleCookie,apiInterface,result;return regeneratorRuntime.wrap(function apiCall$(_context){while(1){switch(_context.prev=_context.next){case 0:extraParams=(0,_scepterUtilityLib.valueOrDefault)(extraParams,injectedExtraParams);makeSelectJwtSelector=(0,_scepterUtilityLib.valueOrDefault)(injectMakeSelectJwt,_selectors.makeSelectJwt);makeSelectExpiresSelector=(0,_scepterUtilityLib.valueOrDefault)(injectMakeSelectExpires,_selectors.makeSelectExpires);makeSelectDoubleCookieSelector=(0,_scepterUtilityLib.valueOrDefault)(injectMakeSelectDoubleCookie,_selectors.makeSelectDoubleCookie);handleDoubleCookie=(0,_scepterUtilityLib.valueOrDefault)(injectedHandleDoubleCookie,handleDoubleCookieFunction);_context.next=7;return(0,_effects.select)(makeSelectJwtSelector());case 7:jwt=_context.sent;_context.next=10;return(0,_effects.select)(makeSelectExpiresSelector());case 10:expires=_context.sent;_context.next=13;return(0,_effects.select)(makeSelectDoubleCookieSelector());case 13:doubleCookie=_context.sent;jwt=checkJwtExpiration(jwt,expires);apiInterface=new ApiInterface(jwt,doubleCookie);_context.next=18;return _effects.call.apply(undefined,[[apiInterface,apiToCall],parameters].concat(_toConsumableArray(extraParams)));case 18:result=_context.sent;(0,_scepterUtilityLib.validateApiResult)(result);return _context.delegateYield(handleDoubleCookie(result),'t0',21);case 21:return _context.abrupt('return',result);case 22:case'end':return _context.stop();}}},apiCall,this)}))};function sagaHandler(action,callback,reducerKey,injectedFetchedDoubleCookie,injectedSetApplicationAlertAction,injectedApplicationErrorAction,injectedOutputErrorLog,injectedValidateReducerKey){var fetchedDoubleCookieAction,setApplicationAlertAction,applicationErrorAction,outputErrorLog,validateReducerKey;return regeneratorRuntime.wrap(function sagaHandler$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:fetchedDoubleCookieAction=(0,_scepterUtilityLib.valueOrDefault)(injectedFetchedDoubleCookie,_actions.fetchedDoubleCookie);setApplicationAlertAction=(0,_scepterUtilityLib.valueOrDefault)(injectedSetApplicationAlertAction,_actions.setApplicationAlert);applicationErrorAction=(0,_scepterUtilityLib.valueOrDefault)(injectedApplicationErrorAction,_actions.applicationError);outputErrorLog=(0,_scepterUtilityLib.valueOrDefault)(injectedOutputErrorLog,outputErrorLogFunction);validateReducerKey=(0,_scepterUtilityLib.valueOrDefault)(injectedValidateReducerKey,validateReducerKeyFunction);_context2.prev=5;if(validateReducerKey(action,reducerKey)){_context2.next=8;break}return _context2.abrupt('return');case 8:return _context2.delegateYield(callback(action),'t0',9);case 9:_context2.next=20;break;case 11:_context2.prev=11;_context2.t1=_context2['catch'](5);outputErrorLog(_context2.t1);_context2.next=16;return(0,_effects.put)(fetchedDoubleCookieAction(localStorage.getItem('doubleCookie')));case 16:_context2.next=18;return(0,_effects.put)(setApplicationAlertAction({message:(0,_scepterUtilityLib.valueOrDefault)(_context2.t1.message,'An unexpected error'),type:'error'}));case 18:_context2.next=20;return(0,_effects.put)(applicationErrorAction(_context2.t1));case 20:case'end':return _context2.stop();}}},_marked,this,[[5,11]])}function handleDoubleCookieFunction(result,injectedFetchedDoubleCookie){var fetchedDoubleCookieAction,doubleCookie;return regeneratorRuntime.wrap(function handleDoubleCookieFunction$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:fetchedDoubleCookieAction=(0,_scepterUtilityLib.valueOrDefault)(injectedFetchedDoubleCookie,_actions.fetchedDoubleCookie);if(!(0,_scepterUtilityLib.notEmptyAt)(result,['results','double_cookie'])){_context3.next=6;break}doubleCookie=result.results.double_cookie;localStorage.setItem('doubleCookie',doubleCookie);_context3.next=6;return(0,_effects.put)(fetchedDoubleCookieAction(doubleCookie));case 6:case'end':return _context3.stop();}}},_marked2,this)}function fetchLocalStorageData(action,injectedFetchedLocalStorageItem){var fetchedLocalStorageItemAction,result;return regeneratorRuntime.wrap(function fetchLocalStorageData$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:fetchedLocalStorageItemAction=(0,_scepterUtilityLib.valueOrDefault)(injectedFetchedLocalStorageItem,_actions.fetchedLocalStorageItem);result=(0,_scepterUtilityLib.valueOrDefault)(localStorage.getItem(action.key),action.defaultValue);_context4.next=4;return(0,_effects.put)(fetchedLocalStorageItemAction(action.key,result));case 4:case'end':return _context4.stop();}}},_marked3,this)}function putInLocalStorage(action,injectedPlacedInLocalStorage){var placedInLocalStorageAction;return regeneratorRuntime.wrap(function putInLocalStorage$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:placedInLocalStorageAction=(0,_scepterUtilityLib.valueOrDefault)(injectedPlacedInLocalStorage,_actions.placedInLocalStorage);localStorage.setItem(action.key,action.value);_context5.next=4;return(0,_effects.put)(placedInLocalStorageAction(action.key,action.value));case 4:case'end':return _context5.stop();}}},_marked4,this)}function loadAuthDataFromLocalStorage(injectLoadedAuthFromLocalStorage){var loadedAuthFromLocalStorageActionCreator,jwt,userId,username,userRoles,expires,jwtClaims;return regeneratorRuntime.wrap(function loadAuthDataFromLocalStorage$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:loadedAuthFromLocalStorageActionCreator=(0,_scepterUtilityLib.valueOrDefault)(injectLoadedAuthFromLocalStorage,_actions.loadedAuthFromLocalStorage);jwt=localStorage.getItem('jwt');userId=localStorage.getItem('userId');username=localStorage.getItem('username');userRoles=JSON.parse(localStorage.getItem('userRoles'));expires=Number(localStorage.getItem('expires'));jwtClaims=JSON.parse(localStorage.getItem('jwtClaims'));_context6.next=9;return(0,_effects.put)(loadedAuthFromLocalStorageActionCreator(jwt,userId,username,userRoles,expires,jwtClaims));case 9:case'end':return _context6.stop();}}},_marked5,this)}function localStorageData(){return regeneratorRuntime.wrap(function localStorageData$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return(0,_effects.takeLatest)(_constants.FETCH_LOCAL_STORAGE_ITEM,fetchLocalStorageData);case 2:_context7.next=4;return(0,_effects.takeLatest)(_constants.PLACE_IN_LOCAL_STORAGE,putInLocalStorage);case 4:_context7.next=6;return(0,_effects.takeLatest)(_constants.LOAD_AUTH_FROM_LOCAL_STORAGE,loadAuthDataFromLocalStorage);case 6:case'end':return _context7.stop();}}},_marked6,this)}var checkJwtExpiration=exports.checkJwtExpiration=function checkJwtExpiration(injectedJwt,expires){var jwt=injectedJwt;var nowTimestamp=(0,_moment2.default)().unix();if(expires!==0&&((0,_scepterUtilityLib.isEmpty)(expires)||expires<nowTimestamp)){jwt=''}return jwt};var validateReducerKeyFunction=exports.validateReducerKeyFunction=function validateReducerKeyFunction(action,reducerKey){return(0,_scepterUtilityLib.isEmpty)(reducerKey)||reducerKey===action.reducerKey};var outputErrorLogFunction=exports.outputErrorLogFunction=function outputErrorLogFunction(err,injectedEnvironment){var environment=(0,_scepterUtilityLib.valueOrDefault)(injectedEnvironment,process.env.NODE_ENV);if(environment!=='production'){console.log(err);// eslint-disable-line no-console
}};
